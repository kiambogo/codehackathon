<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html ng-app="project">
<head>

<title>Taxr - Visualize Your Tax Breakdown</title>
<meta name="author" content="Nicole, Chris, Anthony and Rahin">
<meta content="text/html; charset=utf-8" http-equiv="content-type">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=false">
<meta name="description" content="CODE Hackathon Project - Taxr">
<link href='http://fonts.googleapis.com/css?family=Raleway:400,100,200,300,500,600,700,800' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="css/style.css">
<link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
<link rel="icon" href="img/favicon.ico" type="image/x-icon">

<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.13/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.13/angular-resource.min.js">
</script>
<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.13/angular-route.min.js">
</script>
</head>
<body>
	<div class="logo_wrapper">
		<img id="logo_png" src="img/logo_no_bg.png">
	</div>
	<!-- HEADER -->
	<div class="intro_wrapper">
		<div class="timeline">
		</div>
		<div class="content">
			<div class="gradient" id="divider"></div>
			<img id="circle_flag" src="img/circle_flag.png">
			<h2>In 2012, the government of Canada received</h2>
			<h2><span>$</span><div class="timer">745518110000</div> in tax.</h2>
			<h3>Have you ever wondered where your tax goes?</h3>
			<a href="#d3_graphic" class="cta" id="breakdown">View Breakdown</a>
			<a class="cta secondary" id="salary">Salary Decomposed</a>
			<input type="text" id="salary_amount" name="salary_amount" value="$" placeholder="ie. 10000" style="text-align:left">
			<a href="#d3_graphic"><input type="submit" id="salary_submit" name="salary_submit" value="VIEW BREAKDOWN"></a>
		</div>
	</div><!--  intro_wrapper -->
	<div class="intro_background">
		<div class="fadeout"></div>
	</div><!--  intro_background -->

	<!-- D3 THINGS -->
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<div class="d3_graphic" id="d3_graphic">
		<img id="circle_bubble" src="img/circle_graph.png">

		<div class="data_description">
			<div id="data_text">
				<div id="salary_title"  style="display: none">
					<h3 style="display: block">Your Salary Breakdown:</h3>
					<hr>
				</div>
				<h3><span id="percentage">0%</span> is used in</h3>
				<h2 id="sector_name">Hover over the graph for statistics</h2>
				<p>This graph shows the breakdown of tax distribution in the 2012-2013 fiscal year in Canada. You can manipulate around the pie graph to view data breakdown. Click in the center of the graph to zoom out, click on any of the portion of the graph to zoom in to the next layer composition.  </p>
				<a href="#category_wrapper" class="cta_small cta_red">Layer Breakdown</a>
				<a class="cta_small" id="back">Go Back</a>
			</div>
		</div>
	</div><!-- d3_graphic -->
	<div class="clearfix"></div>


	<!-- CATEGORY -->
	<div class="category_wrapper wrapper" id="category_wrapper">
		<ul class="category_navbar">
			<li class="active"><a href="#category_wrapper">Layer Breakdown</a></li>
			<li><a href="#opendata">Open Data</a></li>
			<li><a href="#abouttaxr">About Taxr</a></li>
			<li><a>Share</a></li>
		</ul>
		<div class="category_item wrapper_item">

		<div id="divider" style="height: 1058px"></div>
			<img id="circle_bubble" src="img/circle_personnel.png">
			<h2>Layer one - Ministry</h2>
			<p>The Ministry Layer provides a bigger picture of the federal budget.  This is an aggregation of the spending from each ministry.  Some of the bigger ministries include National Defence, the Ministry of Health, the Ministry of Foreign Affairs,  and Ministry of Agriculture and Agri-Food. </p>
			<a href="http://www.parl.gc.ca/parliamentarians/en/ministries" target="_blank" class="cta_small">More Information</a>

		</div><!-- category_item -->

		<div class="category_item wrapper_item">
			<img id="circle_bubble" src="img/circle_personnel.png">
			<h2>Layer two – Department</h2>
			<p>Within each ministry, there are several departments; each of which contribute to the ministry aggregate and have their own set of programs.  As an example, let’s take the Canadian Heritage Ministry.  This ministry has several departments including Canadian Radio-television Commisision (CRTC), the National Battlefields Commission, the National Film Board, and the Library of Archives of Canada.  </p>
			<a href="http://www.pch.gc.ca/eng/1266037002102/1265993639778" target="_blank" class="cta_small">More Information</a>

		</div><!-- category_item -->

		<div class="category_item wrapper_item">
			<img id="circle_bubble" src="img/circle_personnel.png">
			<h2>Layer three – Program</h2>
			<p>A program can be anything from a budget expense to a new initiative.  Multiple programs contribute to department spending.  This is where the details of government expenditures can be found.  Some details one can find are information of spending on Informatic Services, Scientific and Research Services, Grants and Contributions, Management Consulting, and Acquisition of Equipment.</p>
			<a href="#d3_graphic" class="cta_small">Back to graph</a>
		
		</div><!-- category_item -->
		<div class="clearfix"></div>
	</div><!-- category_wrapper -->

	<!--  MISC INFORMATION -->
	<div class="misc_wrapper wrapper">
		<div class="category_item wrapper_item">
			<div id="divider" style="opacity: 0.6; height: 800px; margin-top: -61px;"></div>
			<img id="circle_bubble" src="img/circle_personnel.png">
			<h2 id="opendata">Open Data </h2>
			<p>The Government of Canada creates massive amounts of data to support services such as health, environment, agriculture and natural resources. Open Data is the practice of making the vast amount of data freely available to anyone to develop all kinds of new and useful products and applications with. </br>Data is Canada's new natural resource. The sky's the limit in terms of what we can do with this material. <span>The Honourable Minister Tony Clement, President of the Treasury Board and CODE Facilitator</span></p>
			<a href="https://www.canadianopendataexperience.com/news/just-what-is-this-open-data-you-speak-of" target="_blank" class="cta_small">Find Out More</a>
			<!-- <a class="cta_small cta_red">Visualize it</a> -->
		</div><!-- category_item -->
		<div class="category_item wrapper_item">
			<img id="circle_bubble" src="img/circle_personnel.png">
			<h2 id="abouttaxr">About Taxr</h2>
			<p>Tax is boring, Tax is complicated, Tax is frustrating!</br>

			Taxr is here to demystify where your tax dollars go, by enabling simple, useful and interactive visualizations to break it down.  </br>

			Taxr provides a breakdown of the federal budget at the Ministry, Department and Department Program levels.  The data is gathered from three government datasets pertaining to Ministerial expenditures, Professional and Special Services, and Transfer Payments as Per the Public Accounts of Canada.   </br>
				
			In addition to seeing a breakdown of the total budget, Taxr provides users with an option to see how their federal tax contribution is broken down based on the budget. </br>

			Taxr is primarily powered by Angular.js and D3.js with a ElasticSearch backend.</p>
			<a href="https://github.com/nicolekjiang" target="_blank" class="userhandle cta_small">@nicolekjiang</a>
			<a href="https://github.com/rjegaraj" target="_blank" class="userhandle cta_small">@rjegaraj</a>
			<a href="https://github.com/kiambogo" target="_blank" class="userhandle cta_small">@kiambogo</a>
			<a href="https://github.com/AnthonyClark" target="_blank" class="userhandle cta_small">@anthonyclark</a>
		</div><!-- category_item -->
		<div class="clearfix"></div>
	</div><!-- misc_wrapper -->
	<div id="fb-root"></div>
		<script>(function(d, s, id) {
		  var js, fjs = d.getElementsByTagName(s)[0];
		  if (d.getElementById(id)) return;
		  js = d.createElement(s); js.id = id;
		  js.src = "//connect.facebook.net/en_GB/all.js#xfbml=1&appId=213338258755676";
		  fjs.parentNode.insertBefore(js, fjs);
		}(document, 'script', 'facebook-jssdk'));</script>
</body>

<script>
	/* SALARY INSERTION*/
	var tax = 745518134170;
	$('#salary_amount').hide();
	$('#salary_submit').hide();
	$('#salary').on("click", function(){
		$('#breakdown').text("<").addClass("shrinkPadding");
		$('#breakdown').removeAttr('href');
		$('#salary_amount').css({
			"padding-left":"25px"
		});
		$('#salary').fadeOut("fast", function(){
			$('#salary_amount').fadeIn("slow");
			$('#salary_submit').fadeIn("medium");
		});
		$('#breakdown').on("click", function(){
			tax = 3840234827387;
			income = tax;
			$("#salary_title").fadeOut();
			$('#salary_amount').fadeOut("medium");
			$('#salary_submit').fadeOut("medium", function(){
				$('#breakdown').text("VIEW BREAKDOWN").removeClass("shrinkPadding").attr('href', "#d3_graphic");
				$('#salary').fadeIn();
			});
		});
		$("#salary_submit").on("click", function() {
			$("#salary_title").fadeIn();
			income = $('#salary_amount').val().substring(1,$('#salary_amount').val().length);

			tax = 0;
			if (income < 11138){
				return;
			}

			income -= 11138;
			if (income < 43953 && income > 0) {
				tax += 0.15 * income;
			}
			else if (income < 87907) {
				tax += 6593;
				income -= 43953;
				tax += 0.22 * income;
			}
			else if (income < 136270) {
				tax += 16263;
				income -= 136270;
				tax += 0.26 * income;
			}
			else {
				tax += 28837;
				income -= 136270;
				tax += 0.29 * income;
			}
		});
	});

	function roundToTwo(num) {    
    	return +(Math.round(num + "e+2")  + "e-2");
	}

	/* smooth scrolling*/
	$(function() {
	  $('a[href*=#]:not([href=#])').click(function() {
	    if (location.pathname.replace(/^\//,'') == this.pathname.replace(/^\//,'') && location.hostname == this.hostname) {
	      var target = $(this.hash);
	      target = target.length ? target : $('[name=' + this.hash.slice(1) +']');
	      if (target.length) {
	        $('html,body').animate({
	          scrollTop: target.offset().top - 55
	        }, 1000);
	        return false;
	      }
	    }
	  });
	});

	/* pin sidebar */
	$(window).scroll(function(){
		$window = $(window);
		if ($window.scrollTop() > 1325){
			$('.category_navbar').addClass("fixSidebar");
			$('#logo_png').addClass("fixLogo");

		}
		else{
			$('.category_navbar').removeClass("fixSidebar");
			$('#logo_png').removeClass("fixLogo");
		}
	});

	/* Number count up*/
	(function($) {
	    $.fn.countTo = function(options) {
	        // merge the default plugin settings with the custom options
	        options = $.extend({}, $.fn.countTo.defaults, options || {});

	        // how many times to update the value, and how much to increment the value on each update
	        var loops = Math.ceil(options.speed / options.refreshInterval),
	            increment = (options.to - options.from) / loops;

	        return $(this).each(function() {
	            var _this = this,
	                loopCount = 0,
	                value = options.from,
	                interval = setInterval(updateTimer, options.refreshInterval);

	            function updateTimer() {
	                value += increment;
	                loopCount++;
	                $(_this).html(value.toFixed(options.decimals));

	                if (typeof(options.onUpdate) == 'function') {
	                    options.onUpdate.call(_this, value);
	                }

	                if (loopCount >= loops) {
	                    clearInterval(interval);
	                    value = options.to;

	                    if (typeof(options.onComplete) == 'function') {
	                        options.onComplete.call(_this, value);
	                    }
	                }
	            }
	        });
	    };

	    $.fn.countTo.defaults = {
	        from: 0,  // the number the element should start at
	        to: 100,  // the number the element should end at
	        speed: 1000,  // how long it should take to count between the target numbers
	        refreshInterval: 40,  // how often the element should be updated
	        decimals: 0,  // the number of decimal places to show
	        onUpdate: null,  // callback method for every time the element is updated,
	        onComplete: null,  // callback method for when the element finishes updating
	    };
	})(jQuery);

	jQuery(function($) {
	    $('.timer').countTo({
	        from: 745518110000,
	        to: 745518134170,
	        speed: 5000,
	        refreshInterval: 50,
	        onComplete: function(value) {
	            console.debug(this);
	        }
	    });
	});

	var margin = {top: 270, right: 400, bottom: 270, left: 300},
	    radius = Math.min(margin.top, margin.right, margin.bottom, margin.left) - 10;

	var hue = d3.scale.category10().domain(d3.range(3,8,9));
	//console.log("Hue - " + d3.scale.category20b() );
	//var hue = ["pink","blue"];

	var luminance = d3.scale.sqrt()
	    .domain([0, 1e6])
	    .clamp(true)
	    .range([90, 20]);

	var svg = d3.select(".d3_graphic").append("svg")
	    .attr("width", margin.left + margin.right)
	    .attr("height", margin.top + margin.bottom)
	  .append("g")
	    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

	var partition = d3.layout.partition()
	    .sort(function(a, b) { return d3.ascending(a.name, b.name); })
	    .size([2 * Math.PI, radius]);

	var arc = d3.svg.arc()
	    .startAngle(function(d) { return d.x; })
	    .endAngle(function(d) { return d.x + d.dx - .01 / (d.depth + .5); })
	    .innerRadius(function(d) { return radius / 3 * d.depth; })
	    .outerRadius(function(d) { return radius / 3 * (d.depth + 1) - 1; });

    // Breadcrumb dimensions: width, height, spacing, width of tip/tail.
	var b = {
	  w: 75, h: 30, s: 10, t: 40
	};

	// Mapping of step names to colors.
	var colors = {
	  "home": "#5687d1",
	  "product": "#7b615c",
	  "search": "#de783b",
	  "account": "#6ab975",
	  "other": "#a173d1",
	  "end": "#bbbbbb"
	};

	d3.json("new3nano.json", function(error, root) {

	  // Compute the initial layout on the entire tree to sum sizes.
	  // Also compute the full name and fill color for each node,
	  // and stash the children so they can be restored as we descend.
	  partition
	      .value(function(d) { return d.size; })
	      .nodes(root)
	      .forEach(function(d) {
	        d._children = d.children;
	        d.sum = d.value;
	        d.key = key(d);
	        d.fill = fill(d);
	      });

	  // Now redefine the value function to use the previously-computed sum.
	  partition
	      .children(function(d, depth) { return depth < 2 ? d._children : null; })
	      .value(function(d) { return d.sum; });

	  var center = svg.append("circle")
	      .attr("r", radius / 3)
	      .on("click", zoomOut);


	  center.append("title")
	      .text("zoom out");

	  var path = svg.selectAll("path")
	      .data(partition.nodes(root).slice(1))
	      .enter().append("path")
	      .attr("d", arc)
	      .style("fill", function(d) { return d.fill; })
	      .each(function(d) { this._current = updateArc(d); })
	      .on("click", zoomIn)
	      .on("mouseover", mouseover);
	// Total size of all segments; we set this later, after loading the data.
		var totalSize = 0; 
		 // Get total size of the tree = value of root node from partition.
		  totalSize = path.node().__data__.value;

		 //initializeBreadcrumbTrail();

		// Given a node in a partition layout, return an array of all of its ancestor
		// nodes, highest first, but excluding the root.
		function getAncestors(node) {
		  var path = [];
		  var current = node;
		  while (current.parent) {
		    path.unshift(current);
		    current = current.parent;
		  }
		  return path;
		}

	  function mouseover(d) {
		  var sequenceArray = getAncestors(d);
		  // Fade all the segments.
	  	  d3.selectAll("path")
	  	  	.transition()
	      	.style("opacity", 0.75);

      		var sector_name = d.name;

      		if ($('#sector_name').text().length > 10){
				//console.log('toolong');
			}
			var percentageString = "$" + (roundToTwo(((tax/745518134170) * d.value))).toLocaleString();			$(".data_percentage").fadeIn();
	  		d3.select("#percentage")
	   		   .text(percentageString)
	   		   .transition()
	   		   .duration(1000);
   		   d3.select("#sector_name")
	   		   .text(sector_name);

		     updateBreadcrumbs(sequenceArray, percentageString);


	      // Then highlight only those that are an ancestor of the current segment.
		  svg.selectAll("path")
		      .filter(function(node) {
		                return (sequenceArray.indexOf(node) >= 0);
		              })
		      .style("opacity", 0.8)
		      .transition();
		}
		d3.selectAll("path").on("mouseover", mouseover);
		function mouseleave(d) {
		  // Deactivate all segments during transition.
		  d3.selectAll("path")
	      .transition()
	      .duration(1500)
	      .style("opacity", 0.8)
	      .each("end", function() {
	          d3.select(this).on("mouseover", mouseover);
	       });
		}

	  function zoomIn(p) {
	  	// dd3.selectAll("path").on("mouseover", null)

	    if (p.depth > 1) p = p.parent;
	    if (!p.children) return;
	    zoom(p, p);
	  }

	  function zoomOut(p) {
	  	//d3.selectAll("path").on("mouseover", null);
	    if (!p.parent) return;
	    zoom(p.parent, p);
	  }


	  // Zoom to the specified new root.
	  function zoom(root, p) {
	    if (document.documentElement.__transition__) return;

	    // Rescale outside angles to match the new layout.
	    var enterArc,
	        exitArc,
	        outsideAngle = d3.scale.linear().domain([0, 2 * Math.PI]);

	    function insideArc(d) {
	      return p.key > d.key
	          ? {depth: d.depth - 1, x: 0, dx: 0} : p.key < d.key
	          ? {depth: d.depth - 1, x: 2 * Math.PI, dx: 0}
	          : {depth: 0, x: 0, dx: 2 * Math.PI};
	    }

	    function outsideArc(d) {
	      return {depth: d.depth + 1, x: outsideAngle(d.x), dx: outsideAngle(d.x + d.dx) - outsideAngle(d.x)};
	    }

	    center.datum(root);

	    // When zooming in, arcs enter from the outside and exit to the inside.
	    // Entering outside arcs start from the old layout.
	    if (root === p) enterArc = outsideArc, exitArc = insideArc, outsideAngle.range([p.x, p.x + p.dx]);

	    path = path.data(partition.nodes(root).slice(1), function(d) { return d.key; });

	    // When zooming out, arcs enter from the inside and exit to the outside.
	    // Exiting outside arcs transition to the new layout.
	    if (root !== p) enterArc = insideArc, exitArc = outsideArc, outsideAngle.range([p.x, p.x + p.dx]);

	    d3.transition().duration(d3.event.altKey ? 7500 : 750).each(function() {
	      path.exit().transition()
	          .style("fill-opacity", function(d) { return d.depth === 1 + (root === p) ? 1 : 0; })
	          .attrTween("d", function(d) { return arcTween.call(this, exitArc(d)); })
	          .remove();

	      path.enter().append("path")
	          .style("fill-opacity", function(d) { return d.depth === 2 - (root === p) ? 1 : 0; })
	          .style("fill", function(d) { return d.fill; })
	          .on("click", zoomIn)
	          .each(function(d) { this._current = enterArc(d); })
	          .on("mouseover", mouseover);

	      path.transition()
	          .style("fill-opacity", 1)
	          .attrTween("d", function(d) { return arcTween.call(this, updateArc(d)); });
	    });
	  }
	});

	function key(d) {
	  var k = [], p = d;
	  while (p.depth) k.push(p.name), p = p.parent;
	  return k.reverse().join(".");
	}

	function fill(d) {
	  var p = d;
	  while (p.depth > 1) p = p.parent;
	  var c = d3.lab(hue(p.name));
	  c.l = luminance(d.sum);
	  return c;
	}

	function arcTween(b) {
	  var i = d3.interpolate(this._current, b);
	  this._current = i(0);
	  return function(t) {
	    return arc(i(t));
	  };
	}

	function updateArc(d) {
	  return {depth: d.depth, x: d.x, dx: d.dx};
	}

	

/* BREADCRUMB*/
	function initializeBreadcrumbTrail() {
	  // Add the svg area.
	  var trail = d3.select(".d3_graphic").append("svg:svg")
	      .attr("width", 220)
	      .attr("height", 50)
	      .attr("id", "trail");
	  // Add the label at the end, for the percentage.
	  trail.append("svg:text")
	    .attr("id", "endlabel")
	    .style("fill", "blue");
	}

// Generate a string that describes the points of a breadcrumb polygon.
function breadcrumbPoints(d, i) {
  var points = [];
  points.push("0,0");
  points.push(b.w + ",0");
  points.push(b.w + b.t + "," + (b.h / 2));
  points.push(b.w + "," + b.h);
  points.push("0," + b.h);
  if (i > 0) { // Leftmost breadcrumb; don't include 6th vertex.
    points.push(b.t + "," + (b.h / 2));
  }
  return points.join(" ");
}

// Update the breadcrumb trail to show the current sequence and percentage.
function updateBreadcrumbs(nodeArray, percentageString) {

  // Data join; key function combines name and depth (= position in sequence).
  var g = d3.select("#trail")
      .selectAll("g")
      .data(nodeArray, function(d) { return d.name + d.depth; });

  // Add breadcrumb and label for entering nodes.
  var entering = g.enter().append("svg:g");

  //entering.append("svg:polygon")
    //  .attr("points", breadcrumbPoints)
      //.style("fill", function(d) { return colors[d.name]; });
      //.style("fill", function(d) { return d.fill; });

  entering.append("svg:text")
      .attr("x", (b.w + b.t))
      .attr("y", b.h+2)
      .attr("dy", "0.5em")
      .attr("text-anchor", "middle")
      .text(function(d) { return d.name; });

  // Set position for entering and updating nodes.
  g.attr("transform", function(d, i) {
    return "translate(" + i * (b.w + b.s) + ", 0)";
  });

  // Remove exiting nodes.
  g.exit().remove();

  // Now move and update the percentage at the end.
  d3.select("#trail").select("#endlabel")
      .attr("x", (nodeArray.length + 0.5) * (b.w + b.s))
      .attr("y", b.h / 2)
      .attr("dy", "0.35em")
      .attr("text-anchor", "middle")
      .text(percentageString);

  // Make the breadcrumb trail visible, if it's hidden.
  d3.select("#trail")
      .style("visibility", "");

}
	
  d3.select(self.frameElement).style("height", margin.top + margin.bottom + "px");

</script>
</html>
